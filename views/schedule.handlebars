<style media="screen">
  .input-group {
    margin-left: 85%;
    width: 250px;
    padding: 10px;
  }
  #calendar {
      max-width: 900px;
      margin: 0 auto;
      /* width: 1200pt;
      margin: auto;
      margin-top: 20pt; */
  }

  .course {
    margin-left: 100%;
    margin-top: 5pt;
    width: 180px;
  }
  .codes {
    margin-left: 50%;
    width: 65px;
  }
</style>
{{#if login}}




<script type="text/javascript">
  // Shows a list of tutors and avaiblity given a course code input.
  // Still working on not showing the already scheduled appointments


  $(function() {
    console.log({{login}});
    $('#find_tutor').on('submit', function(e) {
      e.preventDefault();
      var data = {
        course_name: $('.course').val(),
        course_code: $('.codes').val(),
      };
      // req.body.
      console.log(data);
      $.ajax({
        type: 'post',
        url:'find_tutor',
        data: data,//$(this).serialize(),
        success: function(data) {
          if (data.success != false) {
            $("calendar").show();
            // prepareIntervals
            var evtCount = data.success.length;
            var events = [];
            for (var i = 0; i < evtCount; i++) {
              events.push({
                schedule_id: data.success[i].schedule_id,
                course_id: data.success[i].course_id,
                tutor_id: data.success[i].tutor_id,
                start: data.success[i].date.slice(0,11) + data.success[i].start,
                end: data.success[i].date.slice(0,11) + data.success[i].end
              });
            }
            console.log(events);
            loadCal(events);
          }else{
            console.log("no data returned");
            $("calendar").remove();
          }
        },
        error: function() {
          console.log("Error");
        }
      });
      // Should stop ajax from firing twice
      return false;
    });
    function loadCal(evtArr) {
      $('#calendar').fullCalendar({
        header: {
          left: 'prev,next today',
          center: 'title',
          right: 'month,agendaWeek,agendaDay'
        },
        allDaySlot: false,
        editable: false,
        selectable: false,
        selectHelper: false,
        weekends: false,
        height: 800,
        minTime: "07:00:00",
        maxTime: "21:00:00",
        defaultView: "agendaWeek",
        eventColor: 'green',
        events: evtArr,
        eventTextColor: 'black',
        eventAfterRender: function(event, elt, view ) {
          var formattedTime = moment(event.start, event.end, 'HH:mm').format('HH:mm');
          if(elt.find(".fc-event-title").length === 0) {
            elt.find(".fc-event-time").text(formattedTime + " - " + event.title);
          }else {
            elt.find(".fc-event-time").text(formattedTime);
          }
          elt.find('.fc-title').after("<span>"+ event.description +"</span>");
        },
        eventClick: function(event) {
           var date = event.start._i.slice(0, 10);
           var start = event.start._i.slice(11, 19);
           var end = event.end._i.slice(11, 19);
           var data = {
             'schedule_id': event.schedule_id,
             'course_id': event.course_id,
             'tutor_id': event.tutor_id,
             'date': date,
             'start': start,
             'end': end
             // 'course_id': event.course_id,
           };
           var querystring = encodeQueryData(data);
           location.assign("create_appointment?" + querystring);
         },
        selectOverlap: function(event) {
          return ! event.block;
        }
      });
    }
    function encodeQueryData(data) {
      var ret = [];
      for (let d in data)
      ret.push(encodeURIComponent(d) + '=' + encodeURIComponent(data[d]));
      return "&" + ret.join('&');
    }
    function formatDate(date) {
      var d = new Date(date);
      var month = '' + (d.getMonth() + 1);
      var day = '' + d.getDate();
      var year = d.getFullYear();
      if (month.length < 2) month = '0' + month;
      if (day.length < 2) day = '0' + day;
      return [year, month, day].join('-');
    }
    //
    var series = [
    {name: 'CMPS', code: '161'},
    {name: 'CMPS', code: '163'},
    {name: 'CMPS', code: '480'},
    {name: 'MATH', code: '150'},
    {name: 'MATH', code: '180'}
    ]

    $(".course").change(function(){
    var courseName = $(this).val();
    var options;
    $(series).each(function(index, value){
      if(value.name == courseName){
        options += '<option value="'+value.code+'">'+value.code+'</option>';
      }
    });

    $('.codes').html(options);
    });
  });
</script>

<div class="container" id="info">
  <h2><center>Find A Tutor</center></h2>
</div>
<form action="avaible_search"  method="POST" id="find_tutor">

        <div class="col-md-4" >
         <select class="course">
          <option value=''><strong>Select Course</strong></option>
          <option value="CMPS">CMPS</option>
          <option value="MATH">MATH</option>
    </select>
</div>
<div class="col-md-4" >
    <select class="codes">
    </select>

    <button name="submit" type="submit" class="btn btn-primary">Submit</button>
    </div>
</form>

<script type="text/javascript">
// var series = [
// {name: 'CMPS', code: '161'},
// {name: 'CMPS', code: '163'},
// {name: 'CMPS', code: '480'},
// {name: 'MATH', code: '150'},
// {name: 'MATH', code: '180'}
// ]
//
// $(".course").change(function(){
// var courseName = $(this).val();
// var options;
// $(series).each(function(index, value){
//   if(value.name == courseName){
//     options += '<option value="'+value.code+'">'+value.code+'</option>';
//   }
// });
//
// $('.codes').html(options);
// });

</script>


<div id="calendar"></div>

{{else}}
  <h1 align="center">You need to login to view this page.</h1>
{{/if}}
